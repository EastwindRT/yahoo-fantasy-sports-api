app.get('/dashboard', async (req, res) => {
  if (!req.session.yahooToken) {
    return res.redirect('/auth/yahoo');
  }

  try {
    yf.setUserToken(req.session.yahooToken.access_token);

    // Fetch user's games
    const userGames = await new Promise((resolve, reject) => {
      yf.user.games((err, data) => err ? reject(err) : resolve(data));
    });

    // Fetch user's leagues for the current NFL season
    const currentYear = new Date().getFullYear();
    const nflGame = userGames.games.find(game => game.code === 'nfl' && game.season === currentYear.toString());

    let userLeagues = [];
    if (nflGame) {
      userLeagues = await new Promise((resolve, reject) => {
        yf.user.game_leagues(nflGame.game_key, (err, data) => err ? reject(err) : resolve(data));
      });
    }

    const dashboardHtml = `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Yahoo Fantasy Sports Dashboard</title>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
          h1, h2 { color: #333; }
          .section { margin-bottom: 30px; }
          .menu { list-style-type: none; padding: 0; }
          .menu li { margin-bottom: 10px; }
          .menu a, .button { display: inline-block; text-decoration: none; color: #fff; background-color: #0066cc; padding: 10px 15px; border-radius: 5px; }
          .menu a:hover, .button:hover { background-color: #0056b3; }
          .leagues { list-style-type: none; padding: 0; }
          .leagues li { margin-bottom: 15px; background-color: #f0f0f0; padding: 10px; border-radius: 5px; }
        </style>
      </head>
      <body>
        <h1>Welcome to Your Yahoo Fantasy Sports Dashboard</h1>

        <div class="section">
          <h2>Quick Actions</h2>
          <ul class="menu">
            <li><a href="/test-api">Test API Connection</a></li>
            <li><a href="/myLeagues">View All My Leagues</a></li>
            <li><a href="/user-info">View User Information</a></li>
            <li><a href="/logout">Logout</a></li>
          </ul>
        </div>

        <div class="section">
          <h2>Your NFL Leagues for ${currentYear}</h2>
          ${nflGame ? `
            <ul class="leagues">
              ${userLeagues.games[0].leagues.map(league => `
                <li>
                  <strong>${league.name}</strong> (${league.num_teams} teams)
                  <br>
                  Draft Status: ${league.draft_status}
                  <br>
                  <a href="/league/${league.league_key}" class="button">View League</a>
                </li>
              `).join('')}
            </ul>
          ` : `<p>No NFL leagues found for the current year.</p>`}
        </div>

        <div class="section">
          <h2>Available Games</h2>
          <ul class="leagues">
            ${userGames.games.map(game => `
              <li>
                <strong>${game.name}</strong> (${game.season})
                <br>
                Status: ${game.is_game_over ? 'Game Over' : game.is_offseason ? 'Offseason' : 'Active'}
              </li>
            `).join('')}
          </ul>
        </div>
      </body>
      </html>
    `;

    res.send(dashboardHtml);
  } catch (error) {
    console.error('Error fetching dashboard data:', error);
    res.status(500).send('Error loading dashboard. Please try again later.');
  }
});

// Add a new route for viewing a specific league
app.get('/league/:league_key', async (req, res) => {
  if (!req.session.yahooToken) {
    return res.redirect('/auth/yahoo');
  }

  try {
    yf.setUserToken(req.session.yahooToken.access_token);
    const leagueKey = req.params.league_key;

    const leagueData = await new Promise((resolve, reject) => {
      yf.league.meta(leagueKey, (err, data) => err ? reject(err) : resolve(data));
    });

    const standingsData = await new Promise((resolve, reject) => {
      yf.league.standings(leagueKey, (err, data) => err ? reject(err) : resolve(data));
    });

    const leagueHtml = `
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>${leagueData.name} - Yahoo Fantasy Sports</title>
        <style>
          body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
          h1, h2 { color: #333; }
          .section { margin-bottom: 30px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .button { display: inline-block; text-decoration: none; color: #fff; background-color: #0066cc; padding: 10px 15px; border-radius: 5px; }
          .button:hover { background-color: #0056b3; }
        </style>
      </head>
      <body>
        <h1>${leagueData.name}</h1>
        <div class="section">
          <h2>League Details</h2>
          <p>Season: ${leagueData.season}</p>
          <p>Number of Teams: ${leagueData.num_teams}</p>
          <p>Scoring Type: ${leagueData.scoring_type}</p>
          <p>Draft Status: ${leagueData.draft_status}</p>
        </div>
        <div class="section">
          <h2>Standings</h2>
          <table>
            <tr>
              <th>Rank</th>
              <th>Team Name</th>
              <th>W</th>
              <th>L</th>
              <th>T</th>
              <th>Points For</th>
            </tr>
            ${standingsData.standings.map(team => `
              <tr>
                <td>${team.rank}</td>
                <td>${team.name}</td>
                <td>${team.number_of_moves}</td>
                <td>${team.number_of_trades}</td>
                <td>${team.clinched_playoffs === '1' ? 'Yes' : 'No'}</td>
                <td>${team.points_for}</td>
              </tr>
            `).join('')}
          </table>
        </div>
        <a href="/dashboard" class="button">Back to Dashboard</a>
      </body>
      </html>
    `;

    res.send(leagueHtml);
  } catch (error) {
    console.error('Error fetching league data:', error);
    res.status(500).send('Error loading league data. Please try again later.');
  }
});