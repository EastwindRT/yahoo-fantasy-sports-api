<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo Fantasy Sports Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">Yahoo Fantasy Sports Dashboard</h1>
            <a href="/logout" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Logout</a>
        </header>

        <div id="user-info" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4"></div>

        <div class="mb-4">
            <label for="year-select" class="block text-gray-700 text-sm font-bold mb-2">Select Year:</label>
            <select id="year-select" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Select a year</option>
            </select>
        </div>

        <h2 class="text-2xl font-bold mb-4">My Leagues</h2>
        <div id="leagues-table" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
            <p class="text-gray-700">Select a year to view leagues...</p>
        </div>

        <h2 class="text-2xl font-bold mb-4">League Details</h2>
        <div class="mb-4">
            <select id="league-select" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="">Select a league</option>
            </select>
        </div>
        <div id="league-details" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4"></div>
        <div id="standings-table" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4"></div>
    </div>

    <script>
        function loadYears() {
            fetch('/api/user')
                .then(response => response.json())
                .then(data => {
                    const yearSelect = document.getElementById('year-select');
                    const years = data.games
                        .filter(game => game.code === 'nba')
                        .map(game => game.season)
                        .sort((a, b) => b - a);

                    years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });

                    yearSelect.addEventListener('change', loadLeagues);

                    // Display user info
                    const userInfo = document.getElementById('user-info');
                    userInfo.innerHTML = `
                        <p><strong>User GUID:</strong> ${data.guid}</p>
                        <p><strong>Games:</strong> ${data.games.map(g => g.name).join(', ')}</p>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching user data:', error);
                    document.getElementById('user-info').innerHTML = `<p class="text-red-500">Error loading user data. Please try again.</p>`;
                });
        }

        function loadLeagues() {
            const year = document.getElementById('year-select').value;
            if (!year) return;

            fetch(`/api/my-leagues/${year}`)
                .then(response => response.json())
                .then(data => {
                    displayLeagues(data.leagues);
                    populateLeagueSelect(data.leagues);
                })
                .catch(error => {
                    console.error('Error fetching leagues:', error);
                    document.getElementById('leagues-table').innerHTML = `
                        <p class="text-red-500">Error fetching leagues: ${error.message}</p>
                        <p>Please try again later.</p>
                    `;
                });
        }

        function displayLeagues(leagues) {
            const leaguesTable = document.getElementById('leagues-table');
            if (leagues && leagues.length > 0) {
                let tableHTML = `
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left">Name</th>
                                <th class="px-4 py-2 text-left">Teams</th>
                                <th class="px-4 py-2 text-left">Draft Status</th>
                                <th class="px-4 py-2 text-left">Scoring Type</th>
                                <th class="px-4 py-2 text-left">Type</th>
                                <th class="px-4 py-2 text-left">Current Week</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                leagues.forEach(league => {
                    tableHTML += `
                        <tr>
                            <td class="border px-4 py-2">${league.name}</td>
                            <td class="border px-4 py-2">${league.num_teams}</td>
                            <td class="border px-4 py-2">${league.draft_status}</td>
                            <td class="border px-4 py-2">${league.scoring_type}</td>
                            <td class="border px-4 py-2">${league.league_type}</td>
                            <td class="border px-4 py-2">${league.current_week}</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                leaguesTable.innerHTML = tableHTML;
            } else {
                leaguesTable.innerHTML = '<p class="text-gray-700">No leagues found for the selected year.</p>';
            }
        }

        function populateLeagueSelect(leagues) {
            const leagueSelect = document.getElementById('league-select');
            leagueSelect.innerHTML = '<option value="">Select a league</option>';
            leagues.forEach(league => {
                const option = document.createElement('option');
                option.value = league.league_key;
                option.textContent = league.name;
                leagueSelect.appendChild(option);
            });
            leagueSelect.addEventListener('change', loadLeagueDetails);
        }

        function loadLeagueDetails() {
            const leagueKey = document.getElementById('league-select').value;
            if (!leagueKey) return;

            fetch(`/api/league/${leagueKey}`)
                .then(response => response.json())
                .then(data => {
                    displayLeagueDetails(data.league);
                    displayStandings(data.standings);
                })
                .catch(error => {
                    console.error('Error fetching league details:', error);
                    document.getElementById('league-details').innerHTML = `
                        <p class="text-red-500">Error fetching league details: ${error.message}</p>
                        <p>Please try again later.</p>
                    `;
                    document.getElementById('standings-table').innerHTML = '';
                });
        }

        function displayLeagueDetails(league) {
            const leagueDetails = document.getElementById('league-details');
            leagueDetails.innerHTML = `
                <h3 class="text-xl font-bold mb-2">${league.name}</h3>
                <p><strong>League ID:</strong> ${league.league_id}</p>
                <p><strong>Season:</strong> ${league.season}</p>
                <p><strong>Start Date:</strong> ${league.start_date}</p>
                <p><strong>End Date:</strong> ${league.end_date}</p>
                <p><strong>Weekly Deadline:</strong> ${league.weekly_deadline}</p>
            `;
        }

        function displayStandings(standings) {
            const standingsTable = document.getElementById('standings-table');
            if (standings && standings.length > 0) {
                let tableHTML = `
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="px-4 py-2 text-left">Rank</th>
                                <th class="px-4 py-2 text-left">Team Name</th>
                                <th class="px-4 py-2 text-left">W</th>
                                <th class="px-4 py-2 text-left">L</th>
                                <th class="px-4 py-2 text-left">T</th>
                                <th class="px-4 py-2 text-left">Winning %</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                standings.forEach(team => {
                    tableHTML += `
                        <tr>
                            <td class="border px-4 py-2">${team.rank}</td>
                            <td class="border px-4 py-2">${team.name}</td>
                            <td class="border px-4 py-2">${team.outcome_totals.wins}</td>
                            <td class="border px-4 py-2">${team.outcome_totals.losses}</td>
                            <td class="border px-4 py-2">${team.outcome_totals.ties}</td>
                            <td class="border px-4 py-2">${team.outcome_totals.percentage}</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                standingsTable.innerHTML = tableHTML;
            } else {
                standingsTable.innerHTML = '<p class="text-gray-700">No standings data available.</p>';
            }
        }

        loadYears();
    </script>
</body>
</html>