<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Yahoo Fantasy Sports API</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .error { color: red; }
        .loading { color: #888; }
        select { margin-bottom: 20px; }
        .logout-button { float: right; }
    </style>
</head>
<body>
    <h1>Yahoo Fantasy Sports Dashboard</h1>
    <a href="/logout" class="logout-button">Logout</a>
    <div id="user-info"></div>

    <label for="year-select">Select Year:</label>
    <select id="year-select">
        <option value="">Select a year</option>
    </select>

    <h2>My Leagues</h2>
    <div id="leagues-table" class="loading">Select a year to view leagues...</div>

    <h2>League Details</h2>
    <select id="league-select">
        <option value="">Select a league</option>
    </select>
    <div id="league-details"></div>
    <div id="standings-table"></div>

    <script>
        function loadYears() {
            fetch('/available-years')
                .then(response => response.json())
                .then(data => {
                    const yearSelect = document.getElementById('year-select');
                    data.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                    yearSelect.addEventListener('change', loadDashboard);
                })
                .catch(error => {
                    console.error('Error fetching available years:', error);
                    document.getElementById('year-select').innerHTML = `<option value="">Error loading years</option>`;
                });
        }

        function loadDashboard() {
            const year = document.getElementById('year-select').value;
            if (!year) return;

            fetch(`/my-leagues/${year}`)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    displayUserInfo(data.user, data.game);
                    displayLeagues(data.leagues);
                    populateLeagueSelect(data.leagues);
                })
                .catch(error => {
                    console.error('Detailed error fetching leagues:', error);
                    document.getElementById('leagues-table').innerHTML = `
                        <p class="error">Error fetching leagues: ${error.message}</p>
                        <p>Please check the console for more details and try again later.</p>
                    `;
                });
        }

        function displayUserInfo(user, game) {
            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = `
                <p><strong>User GUID:</strong> ${user.guid}</p>
                <p><strong>Game:</strong> ${game.name} ${game.season}</p>
                <p><strong>Game Over:</strong> ${game.is_game_over ? 'Yes' : 'No'}</p>
                <p><strong>Offseason:</strong> ${game.is_offseason ? 'Yes' : 'No'}</p>
            `;
        }

        function displayLeagues(leagues) {
            const leaguesTable = document.getElementById('leagues-table');
            if (leagues && leagues.length > 0) {
                let tableHTML = `
                    <table>
                        <tr>
                            <th>Name</th>
                            <th>Teams</th>
                            <th>Draft Status</th>
                            <th>Scoring Type</th>
                            <th>Type</th>
                            <th>Current Week</th>
                        </tr>
                `;
                leagues.forEach(league => {
                    tableHTML += `
                        <tr>
                            <td>${league.name}</td>
                            <td>${league.num_teams}</td>
                            <td>${league.draft_status}</td>
                            <td>${league.scoring_type}</td>
                            <td>${league.league_type}</td>
                            <td>${league.current_week}</td>
                        </tr>
                    `;
                });
                tableHTML += '</table>';
                leaguesTable.innerHTML = tableHTML;
            } else {
                leaguesTable.innerHTML = '<p>No leagues found for the selected year.</p>';
            }
        }

        function populateLeagueSelect(leagues) {
            const leagueSelect = document.getElementById('league-select');
            leagueSelect.innerHTML = '<option value="">Select a league</option>';
            leagues.forEach(league => {
                const option = document.createElement('option');
                option.value = league.league_key;
                option.textContent = league.name;
                leagueSelect.appendChild(option);
            });
        }

        document.getElementById('league-select').addEventListener('change', (event) => {
            const leagueKey = event.target.value;
            if (leagueKey) {
                fetch(`/league/${leagueKey}`)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        displayLeagueDetails(data.league);
                        displayStandings(data.standings);
                    })
                    .catch(error => {
                        console.error('Error fetching league details:', error);
                        document.getElementById('league-details').innerHTML = `
                            <p class="error">Error fetching league details: ${error.message}</p>
                            <p>This might be due to the league being inactive or not having any current data.</p>
                        `;
                        document.getElementById('standings-table').innerHTML = '';
                    });
            } else {
                document.getElementById('league-details').innerHTML = '';
                document.getElementById('standings-table').innerHTML = '';
            }
        });

        function displayLeagueDetails(league) {
            const leagueDetails = document.getElementById('league-details');
            leagueDetails.innerHTML = `
                <h3>${league.name}</h3>
                <p><strong>League ID:</strong> ${league.league_id}</p>
                <p><strong>Season:</strong> ${league.season}</p>
                <p><strong>Start Date:</strong> ${league.start_date}</p>
                <p><strong>End Date:</strong> ${league.end_date}</p>
                <p><strong>Weekly Deadline:</strong> ${league.weekly_deadline}</p>
            `;
        }

        function displayStandings(standings) {
            const standingsTable = document.getElementById('standings-table');
            if (standings && standings.length > 0) {
                let tableHTML = `
                    <table>
                        <tr>
                            <th>Rank</th>
                            <th>Team Name</th>
                            <th>W</th>
                            <th>L</th>
                            <th>T</th>
                            <th>Winning %</th>
                        </tr>
                `;
                standings.forEach(team => {
                    tableHTML += `
                        <tr>
                            <td>${team.rank}</td>
                            <td>${team.name}</td>
                            <td>${team.outcome_totals.wins}</td>
                            <td>${team.outcome_totals.losses}</td>
                            <td>${team.outcome_totals.ties}</td>
                            <td>${team.outcome_totals.percentage}</td>
                        </tr>
                    `;
                });
                tableHTML += '</table>';
                standingsTable.innerHTML = tableHTML;
            } else {
                standingsTable.innerHTML = '<p>No standings data available.</p>';
            }
        }

        loadYears();
    </script>
</body>
</html>